<vex-page-layout @fadeInRight>
  <vex-page-layout-content [class.container]="layoutCtrl.value === 'boxed'"
    [class.px-6]="layoutCtrl.value === 'fullwidth'" class="-mt-6">
    <div class="card overflow-auto pd-5 mt-3">
      <div class="container-fluid py-3">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h6 class="card-title mb-3">Monederos · Totales</h6>
                <dx-pie-chart [dataSource]="monederosResumen" palette="Soft" [size]="{ height: 320 }"
                  [resolveLabelOverlapping]="'shift'"
                  [tooltip]="{ enabled: true, format: '#,##0', customizeTooltip: customizeTooltip }" [legend]="{
                    horizontalAlignment: 'right',
                    verticalAlignment: 'top'
                  }">
                  <dxi-series argumentField="tipo" valueField="total" [label]="{ visible: true, format: 'currency' }">
                  </dxi-series>
                </dx-pie-chart>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h6 class="card-title mb-3">Vehículos · Estatus</h6>
                <dx-chart [dataSource]="vehiculosEstatus" palette="Material" [size]="{ height: 320 }"
                  [tooltip]="{ enabled: true, format: '#,##0' }" [legend]="{ visible: false }">
                  <dxi-series argumentField="estatus" valueField="total" type="bar"></dxi-series>
                </dx-chart>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="row g-3 mt-2 kpi-row">
              <div class="col-12 col-sm-6 col-xl-3">
                <div class="card h-100 shadow-sm kpi-card">
                  <div class="kpi-head">Usuarios</div>
                  <div class="kpi-body">
                    <div class="kpi-value">{{kpi.usuariosActivos | number}}</div>
                    <div class="kpi-meta">
                      Activos · <span class="text-muted">{{kpi.totalUsuarios | number}} total</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-xl-3">
                <div class="card h-100 shadow-sm kpi-card">
                  <div class="kpi-head">Monederos</div>
                  <div class="kpi-body">
                    <div class="kpi-value">{{kpi.monederosConSaldo | number}}</div>
                    <div class="kpi-meta">
                      Con saldo · <span class="text-muted">{{kpi.porcentajeConSaldo}}%</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-xl-3">
                <div class="card h-100 shadow-sm kpi-card">
                  <div class="kpi-head">Vehículos</div>
                  <div class="kpi-body">
                    <div class="kpi-value">{{kpi.vehiculosInstalados | number}}</div>
                    <div class="kpi-meta">
                      Instalados · <span class="text-muted">{{kpi.vehiculosLibres | number}} libres</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-xl-3">
                <div class="card h-100 shadow-sm kpi-card">
                  <div class="kpi-head">Hoy</div>
                  <div class="kpi-body">
                    <div class="kpi-value">$
                      {{kpi.hoy.recargas | number:'1.0-0'}}
                    </div>
                    <div class="kpi-meta">
                      Recargas · Débitos ${{kpi.hoy.debitos | number:'1.0-0'}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="row g-3 mt-2 kpi-row">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h6 class="card-title mb-3">Transacciones · Mensual</h6>
                  <dx-chart [dataSource]="transaccionesMes" palette="Harmony Light" [size]="{ height: 360 }"
                    [tooltip]="{ enabled: true, shared: true, customizeTooltip: customizeTooltip }" [legend]="{
                      position: 'outside',
                      horizontalAlignment: 'center',
                      verticalAlignment: 'bottom'
                    }">
                    <dxi-series valueField="recargas" argumentField="mes" name="Recargas" type="line">
                    </dxi-series>
                    <dxi-series valueField="debitos" argumentField="mes" name="Débitos" type="line">
                    </dxi-series>
                  </dx-chart>
                </div>
              </div>
            </div>
          </div>
         <!-- ===== Últimas Transacciones (DevExtreme DataGrid) ===== -->
<div class="col-12">
  <div class="row g-3 mt-2 kpi-row">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-3">
          Últimas Transacciones
          <span class="subtitle">Movimientos recientes de monederos</span>
        </h6>

        <dx-data-grid
          class="dx-grid-transacciones"
          [dataSource]="ultimasTransacciones"
          [columnAutoWidth]="true"
          [wordWrapEnabled]="true"
          [rowAlternationEnabled]="true"
          [hoverStateEnabled]="true"
          [showBorders]="false"
          [allowColumnResizing]="true"
          columnResizingMode="widget"
          [paging]="{ pageSize: 10 }"
          [pager]="{ visible: false }">

          <dxi-column caption="#" width="60" cellTemplate="rowIndexTpl"></dxi-column>
          <dxi-column dataField="usuario" caption="Usuario"></dxi-column>
          <dxi-column dataField="tipo" caption="Tipo" cellTemplate="tipoTpl" width="120"></dxi-column>
          <dxi-column dataField="monto" caption="Monto" dataType="number" format="currency" width="130"></dxi-column>
          <dxi-column dataField="fecha" caption="Fecha" width="130"></dxi-column>
          <dxi-column dataField="estatus" caption="Estatus" cellTemplate="estatusTpl" width="140"></dxi-column>

          <!-- # (row index) -->
          <div *dxTemplate="let d of 'rowIndexTpl'">{{ d.rowIndex + 1 }}</div>

          <!-- Badge Tipo -->
          <div *dxTemplate="let d of 'tipoTpl'">
            <span class="badge" [ngClass]="d.data.tipo === 'Recarga' ? 'bg-success' : 'bg-danger'">
              {{ d.data.tipo }}
            </span>
          </div>

          <!-- Badge Estatus -->
          <div *dxTemplate="let d of 'estatusTpl'">
            <span class="badge rounded-pill"
              [ngClass]="{
                'bg-success': d.data.estatus === 'Completada',
                'bg-warning text-dark': d.data.estatus === 'Pendiente',
                'bg-danger': d.data.estatus === 'Fallida'
              }">
              {{ d.data.estatus }}
            </span>
          </div>
        </dx-data-grid>

      </div>
    </div>
  </div>
</div>

        </div>
      </div>
    </div>
  </vex-page-layout-content>
</vex-page-layout>